#download samples from malwarebazaar
#hash file can be found at https://bazaar.abuse.ch/export/
import requests
import sys
import pyzipper
import os

#number of samples to be downloaded
NUMBER_OF_SAMPLES = 5

PASSWORD = b'infected'

headers = { 'API-KEY': '89ce6ff37f785312974a6dc8491290dc' }

def remove_file(_hash):
    os.remove(_hash + '.zip')

def download_sample(_hash):
    data = {
        'query': 'get_file',
        'sha256_hash': _hash,
    }
    resp = requests.post('https://mb-api.abuse.ch/api/v1/', data = data, timeout = (10, 200), headers=headers, allow_redirects=True)
    if 'file_not_found' in resp.text:
        print("404 error for " + hash)
        return
    else:
        file = open(_hash +'.zip', 'wb')
        file.write(resp.content)
        file.close()
        with pyzipper.AESZipFile(_hash +".zip") as zf:
                zf.pwd = PASSWORD
                _extract = zf.extractall("Download/")  
                print("Sample `" + _hash + "` downloaded and unzipped")
        remove_file(_hash)

hash_file = open('Download/sha256_dreb.txt', 'r')
get_hashes = hash_file.readlines()

count = 0

for hash in get_hashes:
    download_sample(hash.strip())
    count += 1
    if count == NUMBER_OF_SAMPLES:
        sys.exit()

